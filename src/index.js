//Global state variable for temperature
let state = {
  temperature: 21, // Valor inicial en ¬∞C
  isCelsius: true
};
//Get the:
//Temperature and state values 
const tempValue = document.getElementById("tempValue");
const landscape = document.getElementById("landscape");
//Increase and decrease buttons
const increaseBtn = document.getElementById("increaseTempControl");
const decreaseBtn = document.getElementById("decreaseTempControl");
// Handles Input related with the city 
const headerCityName = document.getElementById("headerCityName");
const cityNameInput = document.getElementById("cityNameInput");
const cityNameReset = document.getElementById("cityNameReset");
// Gets the temperature 
const currentTempButton = document.getElementById("currentTempButton");
//Convert C/F 
const convertTempButton = document.getElementById("convertTempButton");
// Select bar 
const skySelect = document.getElementById("skySelect");
const skyDisplay = document.getElementById("sky");


//function for update the temperature and display
const updateTempDisplay = () => {

  const {temperature, isCelsius} = state;
  // const temperature = state.temperature;
  tempValue.textContent = isCelsius ? `${temperature}¬∞C` : `${temperature}¬∞F`;
  
  if (temperature >= 27) {
    tempValue.className = "red";
    landscape.textContent = "üåµ__üêç_ü¶Ç_üåµüåµ__üêç_üèú_ü¶Ç";
  } else if (temperature >= 21) {
    tempValue.className = "orange";
    landscape.textContent = "üå∏üåøüåº__üå∑üåªüåø_‚òòÔ∏èüå±_üåªüå∑";
  } else if (temperature >= 15) {
    tempValue.className = "yellow";
    landscape.textContent = "üåæüåæ_üçÉ_ü™®__üõ§_üåæüåæüåæ_üçÉ";
  } else if (temperature >= 10) {
    tempValue.className = "green";
    landscape.textContent = "üå≤üå≤‚õÑÔ∏èüå≤‚õÑÔ∏èüçÇüå≤üçÅüå≤üå≤‚õÑÔ∏èüçÇüå≤";
  } else {
    tempValue.className = "teal";
    landscape.textContent = "üå≤üå≤‚õÑÔ∏èüå≤‚ùÑÔ∏èüå¨Ô∏è‚õÑÔ∏èüå≤‚ùÑÔ∏è‚õÑÔ∏èüå≤";
  }
};

const convertTemp = () => {
  const temperatureHeader = document.getElementById("temperatureHeader");

  if (state.isCelsius) {
    state.temperature = Math.round(state.temperature * 9 / 5 + 32);
    convertTempButton.textContent = "Convert to ¬∞C";
    temperatureHeader.textContent = "Temperature (¬∞F)";
  } else {
    state.temperature = Math.round((state.temperature - 32) * 5 / 9);
    convertTempButton.textContent = "Convert to ¬∞F";
    temperatureHeader.textContent = "Temperature (¬∞C)";
  }

  state.isCelsius = !state.isCelsius;
  updateTempDisplay();
};

const updateSky = () => {
  const sky = skySelect.value;

  if (sky === "sunny") {
    skyDisplay.textContent = "‚òÅÔ∏è ‚òÅÔ∏è ‚òÅÔ∏è ‚òÄÔ∏è ‚òÅÔ∏è ‚òÅÔ∏è";
  } else if (sky === "cloudy") {
    skyDisplay.textContent = "‚òÅÔ∏è‚òÅÔ∏è ‚òÅÔ∏è ‚òÅÔ∏è‚òÅÔ∏è ‚òÅÔ∏è üå§ ‚òÅÔ∏è ‚òÅÔ∏è‚òÅÔ∏è";
  } else if (sky === "rainy") {
    skyDisplay.textContent = "üåßüåà‚õàüåßüåßüíß‚õàüåßüå¶üåßüíßüåßüåß";
  } else if (sky === "snowy") {
    skyDisplay.textContent = "üå®‚ùÑÔ∏èüå®üå®‚ùÑÔ∏è‚ùÑÔ∏èüå®‚ùÑÔ∏èüå®‚ùÑÔ∏è‚ùÑÔ∏èüå®üå®";
  } else {
    skyDisplay.textContent = ""; // default vac√≠o si no hay selecci√≥n
  }
};

//Listeners

//Increase temperature with button
increaseBtn.addEventListener("click", () => {
  state.temperature += 1;
  updateTempDisplay();
});

// Decrease temperature with button
decreaseBtn.addEventListener("click", () => {
  state.temperature -= 1;
  updateTempDisplay();
});

// Update the name of the city in real time
cityNameInput.addEventListener("input", () => {
  headerCityName.textContent = cityNameInput.value;
  
});

// Reset name of the city clicking the button "Reset"
cityNameReset.addEventListener("click", () => {
  cityNameInput.value = "Seattle";
  headerCityName.textContent = "Seattle";
});

skySelect.addEventListener("change", updateSky);

currentTempButton.addEventListener("click", async () => {
  const city = headerCityName.textContent || "Seattle"; // default en caso de estar vac√≠o

  try {
    // Paso 1: Obtener lat y lon
    const locationRes = await axios.get('http://127.0.0.1:5000/location', {
      params: {
        q: city
      }
    });

    const { lat, lon } = locationRes.data[0];

    // Paso 2: Obtener clima actual
    const weatherRes = await axios.get(`http://127.0.0.1:5000/weather`, {
      params: {
        lat,
        lon,
      },
    });
    
    // Paso 3: Convertir de Kelvin a Celsius
    const kelvinTemp = weatherRes.data.main.temp;
    const celsiusTemp = Math.round(kelvinTemp - 273.15);

    // Paso 4: Actualizar estado y UI
    state.temperature = celsiusTemp;
    updateTempDisplay();
  } catch (error) {
    console.error("Error fetching temperature:", error);
  }
});

convertTempButton.addEventListener("click", convertTemp);

updateTempDisplay();
updateSky();